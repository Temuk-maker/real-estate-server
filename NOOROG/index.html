<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <title>Зар оруулах</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 24px auto; }
    label { display:block; margin: 10px 0 6px; }
    input, textarea { width:100%; padding:8px; }
    .row { display:flex; gap:10px; align-items:center; margin:12px 0; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:10px; }
    .thumb { position:relative; border:1px solid #ddd; border-radius:10px; padding:6px; }
    .thumb img { width:100%; height:120px; object-fit:cover; border-radius:8px; }
    .thumb button { position:absolute; top:6px; right:6px; }
    .badge { position:absolute; left:6px; top:6px; padding:2px 6px; background:#111; color:#fff; font-size:12px; border-radius:20px; }
    .thumb.dragging { opacity:0.5; }
    .thumb.drop-target { outline:2px dashed #3b82f6; }
    #msg { margin-top:12px; font-weight:bold; }
  </style>
</head>

<body>
  <h1>Шинэ зар оруулах</h1>

  <label>Гарчиг</label>
  <input id="title" />

  <label>Үнэ (₮)</label>
  <input id="price" type="number" min="0" />

  <label>Тайлбар</label>
  <textarea id="desc" rows="4"></textarea>

  <div class="row">
    <button id="pickBtn">Зураг нэмэх</button>
    <input id="fileInput" type="file" accept="image/*" multiple hidden />
    <a href="./home.html">← Буцах</a>
  </div>

  <div id="imageContainer" class="grid"></div>

  <div class="row">
    <button id="publishBtn">Нийтлэх</button>
  </div>

  <p id="msg"></p>

  <script>
    const API = "http://localhost:3000";

    const pickBtn = document.getElementById("pickBtn");
    const fileInput = document.getElementById("fileInput");
    const container = document.getElementById("imageContainer");
    const msg = document.getElementById("msg");

    let filesPool = [];
    let dragSrc = null;

    // ✅ Зураг нэмэх товч ажиллана
    pickBtn.addEventListener("click", () => fileInput.click());

    // ✅ Зураг сонгоход харагдуулна
    fileInput.addEventListener("change", () => {
      const files = fileInput.files;
      if (!files) return;

      for (const f of files) {
        if (!f.type.startsWith("image/")) continue;
        const idx = filesPool.push(f) - 1;
        addThumb(idx, f);
      }
      refreshBadges();
      fileInput.value = "";
    });

    // ✅ Thumbnail үүсгэх
    function addThumb(idx, file) {
      const card = document.createElement("div");
      card.className = "thumb";
      card.setAttribute("draggable", "true");
      card.dataset.index = idx;

      const badge = document.createElement("div");
      badge.className = "badge";

      const del = document.createElement("button");
      del.textContent = "×";
      del.onclick = () => { card.remove(); refreshBadges(); };

      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.onload = () => URL.revokeObjectURL(img.src);

      // ✅ drag events
      card.addEventListener("dragstart", () => {
        dragSrc = card;
        card.classList.add("dragging");
      });

      card.addEventListener("dragover", (e) => {
        e.preventDefault();
        card.classList.add("drop-target");
      });

      card.addEventListener("dragleave", () => {
        card.classList.remove("drop-target");
      });

      card.addEventListener("drop", () => {
        card.classList.remove("drop-target");
        if (dragSrc === card) return;

        const nodes = [...container.children];
        const srcIndex = nodes.indexOf(dragSrc);
        const tgtIndex = nodes.indexOf(card);

        if (srcIndex < tgtIndex) container.insertBefore(dragSrc, card.nextSibling);
        else container.insertBefore(dragSrc, card);

        refreshBadges();
      });

      card.addEventListener("dragend", () => {
        card.classList.remove("dragging");
        [...container.children].forEach(c => c.classList.remove("drop-target"));
      });

      card.appendChild(badge);
      card.appendChild(del);
      card.appendChild(img);
      container.appendChild(card);
    }

    // ✅ Cover + дараалал badge
    function refreshBadges() {
      [...container.children].forEach((el, i) => {
        el.querySelector(".badge").textContent = i === 0 ? "Cover" : i + 1;
      });
    }

    // ✅ Зар илгээх
    async function submitListing(status) {
      msg.textContent = "";

      const title = document.getElementById("title").value.trim();
      const price = document.getElementById("price").value.trim();
      const desc = document.getElementById("desc").value.trim();

      if (!title) return msg.textContent = "Гарчиг оруулна уу!";
      if (!price) return msg.textContent = "Үнэ оруулна уу!";
      if (container.children.length === 0) return msg.textContent = "Зураг шаардлагатай!";

      const fd = new FormData();
      fd.append("title", title);
      fd.append("price", price);
      fd.append("description", desc);
      fd.append("status", status);

      // ✅ Дарааллаар нь file-уудыг нэмнэ → Cover = эхний зураг
      [...container.children].forEach(card => {
        const idx = card.dataset.index;
        fd.append("images", filesPool[idx]);
      });

      try {
        const res = await fetch(`${API}/api/listings`, { method: "POST", body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message);

        if (status === "published") {
          window.location.href = "home.html"; // ✅ Нийтлэгдсэн → Feed рүү
        } else {
          msg.textContent = "Ноорог хадгаллаа.";
        }

      } catch (e) {
        console.error(e);
        msg.textContent = "Алдаа: сервертэй холбогдож чадсангүй.";
      }
    }
    document.getElementById("publishBtn").onclick = () => submitListing("published");
  </script>
</body>
</html>
