<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <title>–û–ª–æ–Ω –∑—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö + –•–∞–¥–≥–∞–ª–∞—Ö</title>
  <style>
    #imageContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap: 12px; margin-top: 12px; }
    .thumb { position: relative; border: 1px solid #ddd; padding: 6px; border-radius: 8px; }
    .thumb img { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; display:block; }
    .thumb .name { font-size: 12px; margin-top: 4px; word-break: break-all; }
    .thumb button { position: absolute; top: 6px; right: 6px; }
    #actions { margin-top: 12px; display: flex; gap: 8px; }
    #modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
    }
    #modal .box {
      background: #fff; padding: 16px; border-radius: 10px; width: 360px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #modal .row { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .hint { font-size: 12px; color: #555; margin-top: 6px; }
  </style>
</head>
<body>
  <button id="addImageBtn">–ó—É—Ä–∞–≥ –Ω—ç–º—ç—Ö</button>
  <button id="saveBtn">OK / –•–∞–¥–≥–∞–ª–∞—Ö</button>
  <div class="hint">üí° –¢–∞ –æ–ª–æ–Ω –∑—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–∂ –±–æ–ª–Ω–æ. –£—Å—Ç–≥–∞—Ö –±–æ–ª –∑—É—Ä–∞–≥ –¥—ç—ç—Ä—Ö √ó –¥–∞—Ä–Ω–∞.</div>

  <input id="fileInput" type="file" accept="image/*" multiple hidden>

  <div id="imageContainer"></div>

  <!-- –ë–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö –º–æ–¥–∞–ª -->
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="box">
      <h3 id="modalTitle">–•–∞–¥–≥–∞–ª–∞—Ö —Å–æ–Ω–≥–æ–ª—Ç–æ–æ —Å–æ–Ω–≥–æ–Ω–æ —É—É</h3>
      <p>1) –§–æ–ª–¥–µ—Ä —Å–æ–Ω–≥–æ–∂ —à—É—É–¥ —Ñ–∞–π–ª—É—É–¥–∞–∞ —Ö–∞–¥–≥–∞–ª–∞—Ö (—à–∏–Ω—ç Chrome/Edge –¥—ç—ç—Ä –∞–∂–∏–ª–ª–∞–Ω–∞).<br>
      2) –ù—ç–≥ HTML —Ñ–∞–π–ª–¥ (gallery.html) —à–∏–Ω–≥—ç—ç–≥—ç—ç–¥ —Ç–∞—Ç–∞–∂ –∞–≤–∞—Ö.</p>
      <div class="row">
        <button id="cancelModal">–ë–æ–ª–∏—Ö</button>
        <button id="saveAsHtml">HTML –±–æ–ª–≥–æ–Ω —Ç–∞—Ç–∞—Ö</button>
        <button id="saveToFolder">–§–æ–ª–¥–µ—Ä —Ä—É—É –±–∏—á–∏—Ö</button>
      </div>
      <div class="hint">*–§–æ–ª–¥–µ—Ä —Ä—É—É –±–∏—á–∏—Ö –Ω—å –∑”©–≤—Ö”©–Ω File System Access API –¥—ç–º–∂–¥—ç–≥ —Ö”©—Ç”©—á–∏–¥ –∞–∂–∏–ª–ª–∞–Ω–∞.</div>
    </div>
  </div>

  <script>
    const addBtn = document.getElementById('addImageBtn');
    const saveBtn = document.getElementById('saveBtn');
    const fileInput = document.getElementById('fileInput');
    const container = document.getElementById('imageContainer');

    // –î–æ—Ç–æ–æ–¥ —Å–∞–Ω: —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω —Å–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—É—É–¥—ã–≥ —ç–Ω–¥ —Ö–∞–¥–≥–∞–ª–Ω–∞
    /** @type {Array<{file: File, url: string, id: string}>} */
    const picked = [];

    // –¢–æ–≤—á ‚Üí —Ñ–∞–π–ª —Å–æ–Ω–≥–æ—Ö —Ü–æ–Ω—Ö
    addBtn.addEventListener('click', () => fileInput.click());

    // –§–∞–π–ª —Å–æ–Ω–≥–æ–≥–¥–æ—Ö–æ–¥ –æ–ª–æ–Ω –∑—É—Ä–∞–≥ –Ω—ç–º—ç—Ö
    fileInput.addEventListener('change', () => {
      const files = fileInput.files;
      if (!files || files.length === 0) return;

      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;

        const url = URL.createObjectURL(file);
        const id = crypto.randomUUID();
        picked.push({ file, url, id });

        // UI-–¥ thumbnail –Ω—ç–º—ç—Ö
        const card = document.createElement('div');
        card.className = 'thumb';
        card.dataset.id = id;

        const del = document.createElement('button');
        del.type = 'button';
        del.textContent = '√ó';
        del.title = '–£—Å—Ç–≥–∞—Ö';
        del.addEventListener('click', () => removeImage(id));

        const img = document.createElement('img');
        img.src = url;
        img.alt = file.name;

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = file.name;

        card.appendChild(del);
        card.appendChild(img);
        card.appendChild(name);
        container.appendChild(card);

        img.onload = () => URL.revokeObjectURL(url); // preview url-—ç—ç —á”©–ª”©”©–ª–Ω”©
      }

      // –¥–∞—Ä–∞–∞–≥–∏–π–Ω —É–¥–∞–∞ change –∞–∂–∏–ª–ª–∞—Ö—ã–Ω —Ç—É–ª–¥ —Ü—ç–≤—ç—Ä–ª—ç–Ω—ç
      fileInput.value = '';
    });

    function removeImage(id) {
      const idx = picked.findIndex(x => x.id === id);
      if (idx >= 0) {
        picked.splice(idx, 1);
      }
      const el = container.querySelector(`.thumb[data-id="${id}"]`);
      if (el) el.remove();
    }

    // ----- –•–ê–î–ì–ê–õ–ê–• –£–¢–ì–£–£–î -----
    const modal = document.getElementById('modal');
    const cancelModal = document.getElementById('cancelModal');
    const saveAsHtml = document.getElementById('saveAsHtml');
    const saveToFolder = document.getElementById('saveToFolder');

    saveBtn.addEventListener('click', () => {
      if (picked.length === 0) {
        alert('–≠—Ö–ª—ç—ç–¥ –¥–æ—Ä —Ö–∞—è–∂ 1 –∑—É—Ä–∞–≥ –Ω—ç–º–Ω—ç “Ø“Ø.');
        return;
      }
      openModal();
    });

    cancelModal.addEventListener('click', closeModal);
    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; }

    // 1) –ù—ç–≥ HTML —Ñ–∞–π–ª –±–æ–ª–≥–æ–Ω —Ç–∞—Ç–∞—Ö (fallback)
    saveAsHtml.addEventListener('click', async () => {
      try {
        const html = await buildGalleryHTML(picked.map(p => p.file));
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gallery.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        closeModal();
      } catch (e) {
        console.error(e);
        alert('HTML “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.');
      }
    });

    // 2) –§–æ–ª–¥–µ—Ä —Ä—É—É —à—É—É–¥ –±–∏—á–∏—Ö (—à–∏–Ω—ç Chrome/Edge)
    saveToFolder.addEventListener('click', async () => {
      if (!('showDirectoryPicker' in window)) {
        alert('–¢–∞–Ω—ã —Ö”©—Ç”©—á —Ñ–æ–ª–¥–µ—Ä —Ä—É—É —à—É—É–¥ –±–∏—á–∏—Ö–∏–π–≥ –¥—ç–º–∂–∏—Ö–≥“Ø–π –±–∞–π–Ω–∞. "HTML –±–æ–ª–≥–æ–Ω —Ç–∞—Ç–∞—Ö"-–≥ –∞—à–∏–≥–ª–∞–Ω–∞ —É—É.');
        return;
      }
      try {
        const dir = await window.showDirectoryPicker({ mode: 'readwrite' });
        // –§–∞–π–ª—É—É–¥—ã–≥ —Ç—É—Ö–∞–π–Ω –Ω—ç—Ä—ç—ç—Ä –Ω—å –±–∏—á–Ω—ç. –î–∞–≤—Ö—Ü–≤–∞–ª –¥—ç—ç—Ä –Ω—å –±–∏—á–∏—Ö–∏–π–≥ –∞—Å—É—É–Ω–∞.
        for (const { file } of picked) {
          const fileHandle = await dir.getFileHandle(file.name, { create: true });
          const writable = await fileHandle.createWritable();
          await writable.write(file);
          await writable.close();
        }
        closeModal();
        alert('–ê–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–ª–∞–∞!');
      } catch (e) {
        if (e?.name !== 'AbortError') {
          console.error(e);
          alert('–•–∞–¥–≥–∞–ª–∞—Ö —è–≤—Ü–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.');
        }
      }
    });

    // –§–∞–π–ª—ã–≥ data URL –±–æ–ª–≥–æ–æ–¥ –Ω—ç–≥ HTML-–¥ —à–∏–Ω–≥—ç—ç—Ö
    async function buildGalleryHTML(files) {
      const items = [];
      for (const f of files) {
        const dataUrl = await fileToDataURL(f);
        items.push({ name: f.name, dataUrl });
      }
      // –≠–Ω–≥–∏–π–Ω responsive grid –±“Ø—Ö–∏–π HTML
      return `
<!DOCTYPE html>
<html lang="mn">
<meta charset="UTF-8">
<title>Gallery (saved)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
  h1 { font-size: 18px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 12px; }
  figure { margin:0; border:1px solid #ddd; border-radius:8px; padding:8px; }
  img { width:100%; height:180px; object-fit:cover; border-radius:6px; display:block; }
  figcaption { font-size:12px; margin-top:6px; word-break: break-all; color:#444; }
</style>
<h1>–ó—É—Ä–≥–∏–π–Ω —Ü–æ–º–æ–≥ (${items.length} —Ñ–∞–π–ª)</h1>
<div class="grid">
${items.map(it => `
  <figure>
    <img src="${it.dataUrl}" alt="${escapeHtml(it.name)}">
    <figcaption>${escapeHtml(it.name)}</figcaption>
  </figure>
`).join('')}
</div>
</html>`;
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(reader.error);
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, ch => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[ch]));
    }
  </script>
</body>
</html>
