<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <title>–ó–∞—Ä –æ—Ä—É—É–ª–∞—Ö (Drag & Drop reorder)</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 860px; margin: 24px auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap: 10px; }
    .thumb {
      position: relative; border: 1px solid #ddd; border-radius: 8px; padding: 6px;
      background:#fff;
    }
    .thumb img { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; display:block; }
    .thumb button { position: absolute; top: 6px; right: 6px; }
    .thumb .badge { 
      position: absolute; left: 6px; top: 6px; 
      background: #111; color:#fff; font-size: 12px; padding: 2px 6px; border-radius: 999px;
      opacity:.85;
    }
    .thumb.dragging { opacity: .5; }
    .thumb.drop-target { outline: 2px dashed #3b82f6; }
    label { display:block; margin: 10px 0 4px; }
    input, textarea { width: 100%; padding: 8px; }
    .row { display:flex; gap:10px; margin-top: 12px; }
    .hint { font-size: 12px; color: #555; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>–®–∏–Ω—ç –∑–∞—Ä –æ—Ä—É—É–ª–∞—Ö</h1>

  <label>–ì–∞—Ä—á–∏–≥</label>
  <input id="title" placeholder="–ñ: iPhone 13 Pro –∑–∞—Ä–Ω–∞">

  <label>“Æ–Ω—ç (‚ÇÆ)</label>
  <input id="price" type="number" min="0" placeholder="–ñ: 1500000">

  <label>–¢–∞–π–ª–±–∞—Ä</label>
  <textarea id="desc" rows="4" placeholder="–ë–æ–≥–∏–Ω–æ —Ç–∞–π–ª–±–∞—Ä..."></textarea>

  <div class="row">
    <button id="pickBtn">–ó—É—Ä–∞–≥ –Ω—ç–º—ç—Ö</button>
    <input id="fileInput" type="file" accept="image/*" multiple hidden>
  </div>

  <div class="hint">üìå –ó—É—Ä–∞–≥–Ω—É—É–¥–∞–∞ **—á–∏—Ä—á –∑”©”©–∂** –¥–∞—Ä–∞–∞–ª–ª—ã–≥ ”©”©—Ä—á–∏–ª–Ω”©. –≠—Ö–Ω–∏–π –∑—É—Ä–∞–≥ ‚Äî <b>cover</b>.</div>
  <div id="imageContainer" class="grid" aria-label="–ó—É—Ä–≥–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç (—á–∏—Ä–∂ –∑”©”©–∂ –±–æ–ª–Ω–æ)"></div>

  <div class="row">
    <button id="saveDraftBtn">–ù–æ–æ—Ä–æ–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö</button>
    <button id="publishBtn">–ù–∏–π—Ç–ª—ç—Ö</button>
  </div>

  <p id="msg"></p>

  <script>
    const fileInput = document.getElementById('fileInput');
    const pickBtn = document.getElementById('pickBtn');
    const container = document.getElementById('imageContainer');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const publishBtn = document.getElementById('publishBtn');
    const msg = document.getElementById('msg');

    // –î–æ—Ç–æ—Ä—Ö –∂–∞–≥—Å–∞–∞–ª—Ç ‚Äî file –æ–±—ä–µ–∫—Ç —Ö–∞–¥–≥–∞–ª–∞—Ö–≥“Ø–π. –§–∞–π–ª –Ω—å card.dataset.fileIndex-—Ä –¥–∞–º–∂–∏–Ω–∞.
    /** @type {File[]} */
    let filesPool = []; // –±“Ø—Ö —Å–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—É—É–¥ —ç–Ω–¥ —Ü—É–≥–ª–∞—Ä–Ω–∞
    let dragSrcEl = null;

    pickBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', () => {
      const files = fileInput.files;
      if (!files || files.length === 0) return;

      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        const poolIndex = filesPool.push(file) - 1; // push —Ö–∏–π—Å–Ω–∏–π –¥–∞—Ä–∞–∞—Ö index
        addThumb(poolIndex, file);
      }
      refreshBadges();
      fileInput.value = '';
    });

    function addThumb(poolIndex, file) {
      const url = URL.createObjectURL(file);

      const card = document.createElement('div');
      card.className = 'thumb';
      card.setAttribute('draggable', 'true');
      card.dataset.fileIndex = String(poolIndex);

      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = '#';

      const del = document.createElement('button');
      del.type = 'button';
      del.textContent = '√ó';
      del.title = '–£—Å—Ç–≥–∞—Ö';
      del.addEventListener('click', () => removeThumb(card));

      const img = document.createElement('img');
      img.src = url;
      img.alt = file.name;
      img.onload = () => URL.revokeObjectURL(url);

      // Drag events
      card.addEventListener('dragstart', onDragStart);
      card.addEventListener('dragover', onDragOver);
      card.addEventListener('dragleave', onDragLeave);
      card.addEventListener('drop', onDrop);
      card.addEventListener('dragend', onDragEnd);

      card.appendChild(badge);
      card.appendChild(del);
      card.appendChild(img);
      container.appendChild(card);
    }

    function removeThumb(card) {
      card.remove();
      refreshBadges();
    }

    function refreshBadges() {
      // Cover = —ç—Ö–Ω–∏–π –∑—É—Ä–∞–≥. Badge-—É—É–¥–∞–∞ 1..n –≥—ç–∂ —à–∏–Ω—ç—á–∏–ª–Ω—ç.
      [...container.children].forEach((el, i) => {
        const b = el.querySelector('.badge');
        if (b) b.textContent = i === 0 ? 'Cover' : String(i + 1);
      });
    }

    // ---- Drag & Drop ----
    function onDragStart(e) {
      dragSrcEl = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      // Firefox —à–∞–∞—Ä–¥–¥–∞–≥
      e.dataTransfer.setData('text/plain', this.dataset.fileIndex || '');
    }

    function onDragOver(e) {
      e.preventDefault(); // drop –±–æ–ª–æ–º–∂—Ç–æ–π –±–æ–ª–≥–æ–Ω–æ
      if (this === dragSrcEl) return;
      this.classList.add('drop-target');
      e.dataTransfer.dropEffect = 'move';
    }

    function onDragLeave() {
      this.classList.remove('drop-target');
    }

    function onDrop(e) {
      e.preventDefault();
      this.classList.remove('drop-target');
      if (!dragSrcEl || dragSrcEl === this) return;

      // DOM –¥–æ—Ç–æ—Ä –±–∞–π—Ä—à–ª—ã–≥ —Å–æ–ª–∏–Ω–æ
      const nodes = [...container.children];
      const srcIndex = nodes.indexOf(dragSrcEl);
      const targetIndex = nodes.indexOf(this);

      if (srcIndex < 0 || targetIndex < 0) return;

      if (srcIndex < targetIndex) {
        container.insertBefore(dragSrcEl, this.nextSibling);
      } else {
        container.insertBefore(dragSrcEl, this);
      }
      refreshBadges();
    }

    function onDragEnd() {
      this.classList.remove('dragging');
      [...container.children].forEach(el => el.classList.remove('drop-target'));
    }

    // ---- –ò–ª–≥—ç—ç—Ö ----
    async function submitListing(status) {
      msg.textContent = '';
      const title = document.getElementById('title').value.trim();
      const price = document.getElementById('price').value.trim();
      const desc = document.getElementById('desc').value.trim();

      if (!title) { msg.textContent = '–ì–∞—Ä—á–∏–≥ —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π.'; return; }
      if (!price) { msg.textContent = '“Æ–Ω—ç –æ—Ä—É—É–ª–Ω–∞ —É—É.'; return; }
      if (container.children.length === 0) { msg.textContent = '–î–æ—Ä —Ö–∞—è–∂ 1 –∑—É—Ä–∞–≥ –æ—Ä—É—É–ª–Ω–∞ —É—É.'; return; }

      const fd = new FormData();
      fd.append('title', title);
      fd.append('price', price);
      fd.append('description', desc);
      fd.append('status', status); // "draft" | "published"

      // –û–î–û–û–• –î–ê–†–ê–ê–õ–õ–´–ù –î–ê–ì–£–£ –§–ê–ô–õ–£–£–î–´–ì –ù–¨ –ù–≠–ú–ù–≠
      for (const card of [...container.children]) {
        const idx = Number(card.dataset.fileIndex);
        const file = filesPool[idx];
        if (file) fd.append('images', file);
      }

      try {
        const res = await fetch('http://localhost:3000/api/listings', {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || '–ê–ª–¥–∞–∞');
        msg.textContent = (status === 'draft') ? '–ù–æ–æ—Ä–æ–≥ —Ö–∞–¥–≥–∞–ª–ª–∞–∞.' : '–ê–º–∂–∏–ª—Ç—Ç–∞–π –Ω–∏–π—Ç–ª—ç–≤! (Cover –±–æ–ª —ç—Ö–Ω–∏–π –∑—É—Ä–∞–≥)';
      } catch (e) {
        console.error(e);
        msg.textContent = '–°–µ—Ä–≤–µ—Ä—Ç—ç–π —Ö–∞—Ä–∏–ª—Ü–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.';
      }
    }

    document.getElementById('saveDraftBtn').addEventListener('click', () => submitListing('draft'));
    document.getElementById('publishBtn').addEventListener('click', () => submitListing('published'));
  </script>
</body>
</html>
